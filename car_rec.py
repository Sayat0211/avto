import streamlit as st
import json
import os
from datetime import datetime
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import subprocess

DATA_PATH = "car-config-sync/car_data_full.json"
FEEDBACK_PATH = "car-config-sync/user_feedback.json"
ADMIN_PASSWORD = "admin123"

# === Git Auto Push ===
def git_commit_and_push(message="Auto update"):
    try:
        subprocess.run(["git", "add", "."], cwd="car-config-sync", check=True)
        subprocess.run(["git", "commit", "-m", message], cwd="car-config-sync", check=True)
        subprocess.run(["git", "push"], cwd="car-config-sync", check=True)
    except Exception as e:
        print("Git push failed:", e)

# === –ó–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ===
def load_data():
    if os.path.exists(DATA_PATH):
        with open(DATA_PATH, "r", encoding="utf-8") as f:
            return json.load(f)
    else:
        return {
            "–ö—É–∑–æ–≤": {
                '–ø–∏–∫–∞–ø': "–ü–∏–∫–∞–ø ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –≥—Ä—É–∑–æ–≤—ã–º –æ—Ç—Å–µ–∫–æ–º. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –∏ –∫—Ä—É–ø–Ω–æ–≥–∞–±–∞—Ä–∏—Ç–Ω—ã—Ö –≥—Ä—É–∑–æ–≤. –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–µ—Ä–º–µ—Ä–∞–º–∏, —Å—Ç—Ä–æ–∏—Ç–µ–ª—è–º–∏ –∏ –ª—é–±–∏—Ç–µ–ª—è–º–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞. –û–±–ª–∞–¥–∞–µ—Ç –≤—ã—Å–æ–∫–∏–º –∫–ª–∏—Ä–µ–Ω—Å–æ–º, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—É–∫—Å–∏—Ä–æ–≤–∫–∏ —Ç—è–∂–µ–ª—ã—Ö –ø—Ä–∏—Ü–µ–ø–æ–≤ –∏ –æ–±—ã—á–Ω–æ –æ—Å–Ω–∞—â–µ–Ω –ø–æ–ª–Ω—ã–º –ø—Ä–∏–≤–æ–¥–æ–º. –õ—É—á—à–∏–π –≤—ã–±–æ—Ä –¥–ª—è –±–µ–∑–¥–æ—Ä–æ–∂—å—è, —Ç—è–∂–µ–ª—ã—Ö —É—Å–ª–æ–≤–∏–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç—ã –≤ —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏.",
                '–º–∏–Ω–∏–≤—ç–Ω': "–ú–∏–Ω–∏–≤—ç–Ω ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Å–µ–º–µ–π –∏–ª–∏ –≥—Ä—É–ø–ø –ª—é–¥–µ–π. –û—Å–Ω–∞—â–µ–Ω —Ç—Ä–µ–º—è —Ä—è–¥–∞–º–∏ —Å–∏–¥–µ–Ω–∏–π, –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–º —Å–∞–ª–æ–Ω–æ–º –∏ –±–æ–ª—å—à–∏–º –±–∞–≥–∞–∂–Ω—ã–º –æ—Ç–¥–µ–ª–µ–Ω–∏–µ–º. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫, —Å–µ–º–µ–π–Ω—ã—Ö –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫ –≤ —à–∫–æ–ª—É –∏–ª–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è. –ì–ª–∞–≤–Ω—ã–µ –ø–ª—é—Å—ã: –≤–º–µ—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–∞, –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
                '–∫—Ä–æ—Å—Å–æ–≤–µ—Ä': "–ö—Ä–æ—Å—Å–æ–≤–µ—Ä ‚Äî —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å, —Å–æ—á–µ—Ç–∞—é—â–∏–π —á–µ—Ä—Ç—ã –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–∞ –∏ –ª–µ–≥–∫–æ–≤–æ–≥–æ –∞–≤—Ç–æ. –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤—ã—Å–æ–∫–∏–º –∫–ª–∏—Ä–µ–Ω—Å–æ–º, —É–¥–æ–±–Ω–æ–π –ø–æ—Å–∞–¥–∫–æ–π, –≤–º–µ—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–º —Å–∞–ª–æ–Ω–æ–º –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏. –ü–æ–¥—Ö–æ–¥–∏—Ç –∫–∞–∫ –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–æ–π –µ–∑–¥—ã, —Ç–∞–∫ –∏ –¥–ª—è –ø–æ–µ–∑–¥–æ–∫ –ø–æ –Ω–µ–∞—Å—Ñ–∞–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–æ—Ä–æ–≥–∞–º. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –ª—é–¥–µ–π, –≤–µ–¥—É—â–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏, —Å–µ–º–µ–π —Å –¥–µ—Ç—å–º–∏, –ª—é–±–∏—Ç–µ–ª–µ–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π.",
                '—Å–µ–¥–∞–Ω': "–°–µ–¥–∞–Ω ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ç–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–∞–≥–∞–∂–Ω–∏–∫–æ–º –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–º —Å–∞–ª–æ–Ω–æ–º. –õ—É—á—à–∏–π –≤—ã–±–æ—Ä –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏ –¥–∞–ª—å–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫ –ø–æ —Ö–æ—Ä–æ—à–∏–º –¥–æ—Ä–æ–≥–∞–º. –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º —à—É–º–æ–∏–∑–æ–ª—è—Ü–∏–∏, —É–¥–æ–±—Å—Ç–≤–æ–º –ø–æ—Å–∞–¥–∫–∏ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é –Ω–∞ —Ç—Ä–∞—Å—Å–µ. –ü–ª—é—Å—ã: –∫–æ–º—Ñ–æ—Ä—Ç, —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å, –ø—Ä–µ–∑–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥.",
                '—Ö—ç—Ç—á–±–µ–∫': "–•—ç—Ç—á–±–µ–∫ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å —É–∫–æ—Ä–æ—á–µ–Ω–Ω–æ–π –∑–∞–¥–Ω–µ–π —á–∞—Å—Ç—å—é –∏ –ø–æ–¥–Ω–∏–º–∞—é—â–µ–π—Å—è –≤–≤–µ—Ä—Ö –¥–≤–µ—Ä—å—é –±–∞–≥–∞–∂–Ω–∏–∫–∞. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–æ–π –∂–∏–∑–Ω–∏: —É–¥–æ–±–µ–Ω –≤ –ø–∞—Ä–∫–æ–≤–∫–µ, —ç–∫–æ–Ω–æ–º–∏—á–µ–Ω –≤ —Ä–∞—Å—Ö–æ–¥–µ —Ç–æ–ø–ª–∏–≤–∞, –º–∞–Ω–µ–≤—Ä–µ–Ω–µ–Ω –≤ –ø—Ä–æ–±–∫–∞—Ö. –ß–∞—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –º–æ–ª–æ–¥—ã–º–∏ –ª—é–¥—å–º–∏, —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏, –≥–æ—Ä–æ–¥—Å–∫–∏–º–∏ –∂–∏—Ç–µ–ª—è–º–∏, –∫–æ—Ç–æ—Ä—ã–º –≤–∞–∂–Ω—ã –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ —ç–∫–æ–Ω–æ–º–∏—è.",
                '—É–Ω–∏–≤–µ—Ä—Å–∞–ª': "–£–Ω–∏–≤–µ—Ä—Å–∞–ª ‚Äî –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å —É–¥–ª–∏–Ω–µ–Ω–Ω—ã–º –∫—É–∑–æ–≤–æ–º –∏ —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –±–∞–≥–∞–∂–Ω—ã–º –æ—Ç–¥–µ–ª–µ–Ω–∏–µ–º. –û–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è —Å–µ–º–µ–π–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫, –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–≥–∞–∂–∞, –¥–æ–º–∞—à–Ω–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏–ª–∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è. –°–æ—á–µ—Ç–∞–µ—Ç —É–¥–æ–±—Å—Ç–≤–æ —Å–µ–¥–∞–Ω–∞ —Å –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –∫—Ä–æ—Å—Å–æ–≤–µ—Ä–∞. –í—ã–±–æ—Ä –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ü–µ–Ω–∏—Ç –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö.",
                '–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫': "–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ ‚Äî –∫—Ä—É–ø–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å—é, —É—Å–∏–ª–µ–Ω–Ω–æ–π –ø–æ–¥–≤–µ—Å–∫–æ–π –∏ –ø–æ–ª–Ω—ã–º –ø—Ä–∏–≤–æ–¥–æ–º. –°–ø–æ—Å–æ–±–µ–Ω –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—Ç—å —Ç—è–∂–µ–ª—ã–µ –¥–æ—Ä–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: –≥—Ä—è–∑—å, —Å–Ω–µ–≥, –∫–∞–º–Ω–∏, –±—Ä–æ–¥—ã. –ò–¥–µ–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –æ—Ö–æ—Ç–Ω–∏–∫–æ–≤, —Ä—ã–±–æ–ª–æ–≤–æ–≤, –ª—é–±–∏—Ç–µ–ª–µ–π —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏. –ü–ª—é—Å—ã: –º–æ—â–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å."
            },
            "–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è": {
                '–∞–≤—Ç–æ–º–∞—Ç': "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—É—é –µ–∑–¥—É –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è, –ø—Ä–æ–±–æ–∫ –∏ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π. –ü–æ–≤—ã—à–∞–µ—Ç –∫–æ–º—Ñ–æ—Ä—Ç –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –º–µ–≥–∞–ø–æ–ª–∏—Å–∞—Ö.",
                '–º–µ—Ö–∞–Ω–∏–∫–∞': "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á –¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º. –õ—é–±–∏–º–∞ –æ–ø—ã—Ç–Ω—ã–º–∏ –≤–æ–¥–∏—Ç–µ–ª—è–º–∏ –∏ –∞–≤—Ç–æ–ª—é–±–∏—Ç–µ–ª—è–º–∏ –∑–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏—á–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–Ω–∞ –∏ —ç–∫–æ–Ω–æ–º–∏—é —Ç–æ–ø–ª–∏–≤–∞. –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è –∏ –Ω–∞–≤—ã–∫–æ–≤ –≤–æ–∂–¥–µ–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –ø—Ä–æ–±–∫–∞—Ö."
            },
            "–¢–æ–ø–ª–∏–≤–æ": {
                '–±–µ–Ω–∑–∏–Ω': "–ë–µ–Ω–∑–∏–Ω–æ–≤—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Ö–æ—Ä–æ—à—É—é –¥–∏–Ω–∞–º–∏–∫—É —Ä–∞–∑–≥–æ–Ω–∞, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å –∏ —Ç–∏—à–∏–Ω—É —Ä–∞–±–æ—Ç—ã. –ò–¥–µ–∞–ª—å–Ω—ã –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–æ–π –µ–∑–¥—ã –∏ —É–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–≥–æ–≤. –®–∏—Ä–µ –¥–æ—Å—Ç—É–ø–Ω—ã –∏ –¥–µ—à–µ–≤–ª–µ –≤ —Ä–µ–º–æ–Ω—Ç–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥–∏–∑–µ–ª—å–Ω—ã–º–∏ –∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–º–∏.",
                '–¥–∏–∑–µ–ª—å': "–î–∏–∑–µ–ª—å–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –≤—ã—Å–æ–∫–æ–π —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å—é –Ω–∞ –¥–∞–ª—å–Ω–∏—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è—Ö –∏ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º –∫—Ä—É—Ç—è—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º. –ò–¥–µ–∞–ª—å–Ω—ã –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –º–Ω–æ–≥–æ –µ–∑–¥–∏—Ç –ø–æ —Ç—Ä–∞—Å—Å–∞–º, –ø–µ—Ä–µ–≤–æ–∑–∏—Ç –≥—Ä—É–∑—ã –∏–ª–∏ –∂–∏–≤–µ—Ç –≤ —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏. –î–∏–∑–µ–ª—å–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–º–µ—é—Ç –±–æ–ª—å—à–∏–π —Ä–µ—Å—É—Ä—Å –¥–≤–∏–≥–∞—Ç–µ–ª—è, –Ω–æ —Ç—Ä–µ–±—É—é—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.",
                '—ç–ª–µ–∫—Ç—Ä–æ': "–≠–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–µ, –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞—è –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤. –û—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–º–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –∏ —Ç–∏—à–∏–Ω–æ–π —Ö–æ–¥–∞. –ü–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –∂–∏—Ç–µ–ª–µ–π –≥–æ—Ä–æ–¥–æ–≤ —Å —Ä–∞–∑–≤–∏—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∑–∞—Ä—è–¥–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π.",
                '–≥–∏–±—Ä–∏–¥': "–ì–∏–±—Ä–∏–¥–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —Å–æ–≤–º–µ—â–∞—é—Ç –±–µ–Ω–∑–∏–Ω–æ–≤—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å –∏ —ç–ª–µ–∫—Ç—Ä–æ–º–æ—Ç–æ—Ä. –û–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å –≤ –≥–æ—Ä–æ–¥–µ, –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –≤—ã–±—Ä–æ—Å–æ–≤ –∏ –∫–æ–º—Ñ–æ—Ä—Ç. –ü–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —á–∏—Å—Ç—É—é —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—é."
            }
        }

def save_data(data):
    with open(DATA_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    git_commit_and_push("Updated car config")

def save_feedback(entry):
    feedback = []
    feedback_dir = os.path.dirname(FEEDBACK_PATH)
    os.makedirs(feedback_dir, exist_ok=True)  # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç

    if os.path.exists(FEEDBACK_PATH):
        with open(FEEDBACK_PATH, "r", encoding="utf-8") as f:
            feedback = json.load(f)

    feedback.append(entry)

    with open(FEEDBACK_PATH, "w", encoding="utf-8") as f:
        json.dump(feedback, f, ensure_ascii=False, indent=2)

    git_commit_and_push("New feedback entry")


def delete_feedback(index):
    if os.path.exists(FEEDBACK_PATH):
        with open(FEEDBACK_PATH, "r", encoding="utf-8") as f:
            fb_data = json.load(f)
        if 0 <= index < len(fb_data):
            del fb_data[index]
            with open(FEEDBACK_PATH, "w", encoding="utf-8") as f:
                json.dump(fb_data, f, ensure_ascii=False, indent=2)
            git_commit_and_push("Feedback deleted")

category_blocks = load_data()

# === TF-IDF –ø–æ–∏—Å–∫ ===
def prepare_tfidf_data(keywords_dict):
    labels = list(keywords_dict.keys())
    texts = [keywords_dict[k] for k in labels]
    vectorizer = TfidfVectorizer()
    matrix = vectorizer.fit_transform(texts)
    return labels, matrix, vectorizer

def find_best_match(query, labels, matrix, vectorizer, top_k=1):
    query_vec = vectorizer.transform([query])
    similarities = cosine_similarity(query_vec, matrix).flatten()
    top_indices = similarities.argsort()[::-1][:top_k]
    return [(labels[i], round(similarities[i], 3)) for i in top_indices]

def semantic_search_grouped(query, top_k=1):
    grouped_results = {}
    for cat_name, data in category_blocks.items():
        labels, matrix, vectorizer = prepare_tfidf_data(data)
        matches = find_best_match(query, labels, matrix, vectorizer, top_k)
        grouped_results[cat_name] = matches
    return grouped_results

def add_to_category(category, class_label, query):
    if class_label in category_blocks[category]:
        category_blocks[category][class_label] += f" {query}."
    else:
        category_blocks[category][class_label] = query
    save_data(category_blocks)

# === –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ===
st.set_page_config(page_title="–ê–≤—Ç–æ–ü–æ–¥–±–æ—Ä", layout="centered")
st.title("üöò –£–º–Ω—ã–π –ø–æ–¥–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è")

mode = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:", ["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–ê–¥–º–∏–Ω"])
if mode == "–ê–¥–º–∏–Ω":
    password = st.sidebar.text_input("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:", type="password")
    is_admin = password == ADMIN_PASSWORD
else:
    is_admin = False

if not is_admin:
    query = st.text_input("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:")
    if query:
        st.subheader("üîç –õ—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:")
        results = semantic_search_grouped(query, top_k=1)
        feedback = {"query": query, "timestamp": str(datetime.now()), "results": {}, "rating": None, "comment": ""}

        for cat, matches in results.items():
            best_label = matches[0][0] if matches else "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"
            st.markdown(f"**{cat}:** {best_label}")
            feedback["results"][cat] = matches  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å score –¥–ª—è –∞–¥–º–∏–Ω–∞

        st.subheader("üìù –û—Ü–µ–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("üëç –í—Å—ë –ø–æ–¥–æ—à–ª–æ"):
                feedback["rating"] = "like"
                save_feedback(feedback)
                st.success("–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É!")
        with col2:
            if st.button("üëé –ù–µ –ø–æ–¥–æ—à–ª–æ"):
                feedback["rating"] = "dislike"
                feedback["comment"] = st.text_input("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)", key="comment")
                save_feedback(feedback)
                st.warning("–í–∞—à –æ—Ç–∑—ã–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –°–ø–∞—Å–∏–±–æ!")
else:
    st.subheader("üìã –û—Ç—á—ë—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    if os.path.exists(FEEDBACK_PATH):
        with open(FEEDBACK_PATH, "r", encoding="utf-8") as f:
            fb_data = json.load(f)

        sort_option = st.selectbox("–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç–∑—ã–≤–æ–≤:", ["–í—Å–µ", "–¢–æ–ª—å–∫–æ –ª–∞–π–∫–∏", "–¢–æ–ª—å–∫–æ –¥–∏–∑–ª–∞–π–∫–∏"])

        filtered_fb = fb_data
        if sort_option == "–¢–æ–ª—å–∫–æ –ª–∞–π–∫–∏":
            filtered_fb = [x for x in fb_data if x.get("rating") == "like"]
        elif sort_option == "–¢–æ–ª—å–∫–æ –¥–∏–∑–ª–∞–π–∫–∏":
            filtered_fb = [x for x in fb_data if x.get("rating") == "dislike"]

        for i, entry in enumerate(reversed(filtered_fb)):
            feedback_index = len(fb_data) - 1 - i
            short = entry['query'][:40] + '...' if len(entry['query']) > 40 else entry['query']
            with st.expander(f"#{feedback_index + 1} ‚Äî {short}"):
                st.markdown(f"**–ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–æ—Å:** {entry['query']}")
                st.markdown(f"**–û—Ü–µ–Ω–∫–∞:** {entry['rating']}")
                st.markdown(f"**–î–∞—Ç–∞:** {entry['timestamp']}")
                for cat, matches in entry["results"].items():
                    st.markdown(f"**{cat}:**")
                    for label, score in matches:
                        st.write(f"- {label}: {score}")
                if entry.get("comment"):
                    st.markdown(f"**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** {entry['comment']}")

                st.markdown("---")
                st.markdown("**‚û°Ô∏è –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:**")
                fb_cat = st.selectbox("–ö–∞—Ç–µ–≥–æ—Ä–∏—è:", list(category_blocks.keys()), key=f"fbcat_{i}")
                fb_cls = st.selectbox("–ö–ª–∞—Å—Å:", list(category_blocks[fb_cat].keys()), key=f"fbcls_{i}")

                if st.button("üì• –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å", key=f"addfb_{i}"):
                    add_to_category(fb_cat, fb_cls, entry['query'])

                    if "corrections" not in entry:
                        entry["corrections"] = []
                    entry["corrections"].append(f"–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ {fb_cat} ‚Üí {fb_cls}")
                    save_feedback(entry)

                    st.success("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ!")

                if entry.get("corrections"):
                    st.markdown("**üõ† –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:**")
                    for c in entry["corrections"]:
                        st.write("-", c)

                if st.button("üóë –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤", key=f"delfb_{i}"):
                    delete_feedback(feedback_index)
                    st.warning("–û—Ç–∑—ã–≤ —É–¥–∞–ª—ë–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.")

    else:
        st.info("–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    st.markdown("---")
    st.subheader("‚úçÔ∏è –†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π")
    category = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", list(category_blocks.keys()))
    label = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:", list(category_blocks[category].keys()), key="admin_label")
    new_text = st.text_area("–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ:", category_blocks[category][label], height=200)

    if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è", key="save_edit"):
        category_blocks[category][label] = new_text
        save_data(category_blocks)
        st.success("–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")

